---
- name: install the undercloud packages
  hosts: undercloud
  tasks:
    - name: install python-rdomanager-oscplugin
      yum: name=python-rdomanager-oscplugin state=present
      sudo: yes

    - name: install yum-plugin-priorities rdo-manager
      yum: name={{item}} state=present
      sudo: yes
      with_items:
        - yum-plugin-priorities
      when: product.name == "rdo"

    - name: install rdo-manager-deps
      yum: name={{item}} state=present
      sudo: yes
      with_items:
        - python-tripleoclient
      when: product.name == "rdo" or product.full_version == "8-director"

    - name: install python-rdomanager-oscplugin
      yum: name=python-rdomanager-oscplugin state=present
      sudo: yes

    - name: install python-passlib
      yum: name=python-passlib state=present
      sudo: yes

- name: install the undercloud
  hosts: undercloud
  tasks:
    - name: set selinux to permissive for ospd-8 (workaround bug bz 1284133)
      selinux: policy=targeted state=permissive
      sudo: yes
      when: (workarounds['rhbz1280101']['enabled'] is defined and workarounds['rhbz1280101']['enabled'] | bool)

    - name: update hosts file for localhost.localhost (workaround for puppet, discovered on centos7)
      lineinfile: dest=/etc/hosts line="127.0.0.1   localhost localhost.localhost"
      sudo: yes

    - name: install the undercloud
      shell: openstack undercloud install --debug &> {{ instack_user_home }}/undercloud_install_initial_install.log

    - name: copy files to home
      sudo: yes
      command: cp /root/{{ item }} {{ instack_user_home }}/{{ item }}
      with_items:
        - tripleo-undercloud-passwords
        - stackrc

    - name: chown files for stack user
      sudo: yes
      command: chown stack:stack {{ instack_user_home }}/{{ item }}
      with_items:
        - tripleo-undercloud-passwords
        - stackrc

- name: confirm installing the undercloud is idempotent
  hosts: undercloud
  tasks:
    - name: install the undercloud
      shell: openstack undercloud install &> {{ instack_user_home }}/undercloud_install_idempotent_check.log

